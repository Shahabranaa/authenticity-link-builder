<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Backlink Opportunities</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Add cache control meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
      /* Custom styles for the progress bars */
      .metric-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }
      .da-bar { background-color: rgba(59, 130, 246, 0.2); }
      .da-fill { background-color: rgba(59, 130, 246, 1); }
      .pa-bar { background-color: rgba(16, 185, 129, 0.2); }
      .pa-fill { background-color: rgba(16, 185, 129, 1); }
      .spam-bar { background-color: rgba(239, 68, 68, 0.2); }
      .spam-fill { background-color: rgba(239, 68, 68, 1); }
      
      /* Tooltips */
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>

  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Backlink Opportunities</h1>
        <p class="text-gray-600">Find and filter dofollow backlink opportunities from our database of 1000+ websites</p>
        <div class="mt-2">
          <a href="/count.html" class="text-blue-500 hover:underline">Verify Website Count</a>
        </div>
      </header>

      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 mb-6">
          <div class="flex-1">
            <input type="text" id="search" placeholder="Search websites..." 
                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="w-full md:w-auto">
            <select id="categoryFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all">All Categories</option>
              <option value="directories">Directories</option>
              <option value="forums">Forums</option>
              <option value="edu_domains">Educational Domains</option>
              <option value="blog_platforms">Blog Platforms</option>
              <option value="social_bookmarking">Social Bookmarking</option>
              <option value="qa_sites">Q&A Sites</option>
              <option value="local_directories">Local Directories</option>
              <option value="industry_directories">Industry Directories</option>
              <option value="review_sites">Review Sites</option>
              <option value="web_2_profiles">Web 2.0 Profiles</option>
              <option value="news_sites">News Sites</option>
            </select>
          </div>
          <div class="w-full md:w-auto">
            <select id="metricFilter" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="none">Sort By</option>
              <option value="da_high">DA (High to Low)</option>
              <option value="da_low">DA (Low to High)</option>
              <option value="pa_high">PA (High to Low)</option>
              <option value="pa_low">PA (Low to High)</option>
              <option value="spam_low">Spam Score (Low to High)</option>
              <option value="spam_high">Spam Score (High to Low)</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto">
            <thead>
              <tr class="bg-gray-50">
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DA/PA/Spam</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="websiteList" class="bg-white divide-y divide-gray-200">
              <!-- Websites will be populated here -->
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading websites...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="mt-4 flex justify-between items-center">
          <div>
            <button id="prevPage" class="px-4 py-2 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">
              Previous
            </button>
            <button id="nextPage" class="px-4 py-2 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">
              Next
            </button>
            <span class="ml-4">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
          </div>
          <div class="text-right text-gray-600">
            <p>Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> websites</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">Understanding Domain Metrics</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="font-bold text-blue-700">Domain Authority (DA)</h3>
            <p class="text-sm text-gray-700">A score from 1-100 predicting how well a website will rank on search engines. Higher is better.</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="font-bold text-green-700">Page Authority (PA)</h3>
            <p class="text-sm text-gray-700">Similar to DA, but at the page level rather than domain level. Higher is better.</p>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <h3 class="font-bold text-red-700">Spam Score</h3>
            <p class="text-sm text-gray-700">A score from 0-14 indicating how likely a site is to be penalized by search engines. Lower is better.</p>
          </div>
        </div>
        <p class="mt-4 text-sm text-gray-500">Note: These metrics are simulated for demonstration purposes and are not actual metrics from Moz.</p>
      </div>
    </div>

    <script>
      // Global variables
      let allWebsites = [];
      let currentPage = 1;
      const itemsPerPage = 20;
      let filteredSites = [];
      
      // DOM elements
      const websiteList = document.getElementById('websiteList');
      const totalCount = document.getElementById('totalCount');
      const showingCount = document.getElementById('showingCount');
      const currentPageElem = document.getElementById('currentPage');
      const totalPagesElem = document.getElementById('totalPages');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      
      // Load websites from sources_with_metrics.json with cache busting
      const timestamp = new Date().getTime();
      
      // Try to load the real metrics first, and fall back to simulated metrics if not available
      fetch(`sources_with_real_metrics.json?t=${timestamp}`)
        .then(response => {
          if (!response.ok) {
            console.log("Real metrics file not found, falling back to simulated metrics");
            return fetch(`sources_with_metrics.json?t=${timestamp}`);
          }
          console.log("Using real metrics data");
          return response;
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load metrics data: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Loaded data", data);
          
          // Process each category
          Object.entries(data).forEach(([category, items]) => {
            console.log(`Category: ${category}, Items: ${items.length}`);
            items.forEach(item => {
              if (item && item.url && item.metrics) {
                try {
                  allWebsites.push({
                    url: item.url,
                    domain: item.domain,
                    category: category,
                    metrics: item.metrics,
                    status: 'Active'
                  });
                } catch (e) {
                  console.error(`Error processing item: ${JSON.stringify(item)}`, e);
                }
              }
            });
          });

          console.log(`Total valid websites: ${allWebsites.length}`);
          
          // Initial filtering
          applyFilters();
          
          // Setup event listeners
          const searchInput = document.getElementById('search');
          searchInput.addEventListener('input', applyFilters);
          
          const categoryFilter = document.getElementById('categoryFilter');
          categoryFilter.addEventListener('change', applyFilters);
          
          const metricFilter = document.getElementById('metricFilter');
          metricFilter.addEventListener('change', applyFilters);
          
          prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
              currentPage--;
              updateTable();
            }
          });
          
          nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredSites.length / itemsPerPage);
            if (currentPage < totalPages) {
              currentPage++;
              updateTable();
            }
          });
        })
        .catch(error => {
          console.error('Error loading sources:', error);
          websiteList.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-red-500">
                Error loading websites: ${error.message}
              </td>
            </tr>
          `;
        });
      
      function applyFilters() {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        const metricSort = document.getElementById('metricFilter').value;
        
        // Filter sites based on search term and category
        filteredSites = allWebsites.filter(site => {
          const matchesSearch = site.url.toLowerCase().includes(searchTerm) || 
                               (site.domain && site.domain.toLowerCase().includes(searchTerm));
          const matchesCategory = category === 'all' || site.category === category;
          return matchesSearch && matchesCategory;
        });
        
        // Sort by metrics if selected
        if (metricSort !== 'none') {
          filteredSites.sort((a, b) => {
            if (metricSort === 'da_high') {
              return b.metrics.da - a.metrics.da;
            } else if (metricSort === 'da_low') {
              return a.metrics.da - b.metrics.da;
            } else if (metricSort === 'pa_high') {
              return b.metrics.pa - a.metrics.pa;
            } else if (metricSort === 'pa_low') {
              return a.metrics.pa - b.metrics.pa;
            } else if (metricSort === 'spam_low') {
              return a.metrics.spam_score - b.metrics.spam_score;
            } else if (metricSort === 'spam_high') {
              return b.metrics.spam_score - a.metrics.spam_score;
            }
            return 0;
          });
        }
        
        // Reset to first page when filters change
        currentPage = 1;
        
        // Update the table
        updateTable();
      }
      
      function updateTable() {
        // Calculate pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedSites = filteredSites.slice(startIndex, endIndex);
        const totalPages = Math.ceil(filteredSites.length / itemsPerPage);
        
        // Update pagination UI
        currentPageElem.textContent = currentPage;
        totalPagesElem.textContent = totalPages;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        
        // Update counts
        totalCount.textContent = allWebsites.length;
        showingCount.textContent = filteredSites.length;
        
        // Clear table
        websiteList.innerHTML = '';
        
        // Add rows for current page
        if (paginatedSites.length === 0) {
          websiteList.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                No websites found matching your criteria
              </td>
            </tr>
          `;
          return;
        }
        
        paginatedSites.forEach(site => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          
          // Calculate color classes based on metric values
          const daClass = site.metrics.da >= 50 ? 'text-blue-700' : site.metrics.da >= 30 ? 'text-blue-500' : 'text-blue-400';
          const paClass = site.metrics.pa >= 50 ? 'text-green-700' : site.metrics.pa >= 30 ? 'text-green-500' : 'text-green-400';
          const spamClass = site.metrics.spam_score >= 7 ? 'text-red-700' : site.metrics.spam_score >= 4 ? 'text-red-500' : 'text-red-400';
          
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <a href="${site.url}" target="_blank" class="hover:text-blue-600">
                      ${site.domain}
                    </a>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                ${site.category.replace(/_/g, ' ')}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="tooltip">
                <div class="flex items-center mb-1">
                  <span class="w-6 font-semibold text-xs ${daClass}">DA</span>
                  <div class="flex-1 ml-1 metric-bar da-bar">
                    <div class="da-fill h-full" style="width: ${site.metrics.da}%"></div>
                  </div>
                  <span class="ml-1 text-xs font-medium ${daClass}">${site.metrics.da}</span>
                </div>
                <div class="flex items-center mb-1">
                  <span class="w-6 font-semibold text-xs ${paClass}">PA</span>
                  <div class="flex-1 ml-1 metric-bar pa-bar">
                    <div class="pa-fill h-full" style="width: ${site.metrics.pa}%"></div>
                  </div>
                  <span class="ml-1 text-xs font-medium ${paClass}">${site.metrics.pa}</span>
                </div>
                <div class="flex items-center">
                  <span class="w-6 font-semibold text-xs ${spamClass}">SP</span>
                  <div class="flex-1 ml-1 metric-bar spam-bar">
                    <div class="spam-fill h-full" style="width: ${site.metrics.spam_score * 7.14}%"></div>
                  </div>
                  <span class="ml-1 text-xs font-medium ${spamClass}">${site.metrics.spam_score}</span>
                </div>
                <span class="tooltiptext">
                  <strong>Domain Authority:</strong> ${site.metrics.da}/100<br>
                  <strong>Page Authority:</strong> ${site.metrics.pa}/100<br>
                  <strong>Spam Score:</strong> ${site.metrics.spam_score}/14
                </span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <a href="${site.url}" target="_blank" class="text-blue-600 hover:text-blue-900 mr-3">
                <i class="fas fa-external-link-alt"></i> Visit
              </a>
              <button class="text-gray-600 hover:text-gray-900 add-to-favorites mr-2">
                <i class="far fa-star"></i>
              </button>
              <button class="text-gray-600 hover:text-gray-900 copy-url" data-url="${site.url}">
                <i class="far fa-copy"></i>
              </button>
            </td>
          `;
          websiteList.appendChild(row);
        });
        
        // Add event listeners for copy buttons
        document.querySelectorAll('.copy-url').forEach(button => {
          button.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
              this.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => {
                this.innerHTML = '<i class="far fa-copy"></i>';
              }, 2000);
            });
          });
        });
      }
    </script>
  </body>
</html>
